!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Ballade=e()}}(function(){return function e(t,r,n){function s(a,o){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!o&&u)return u(a,!0);if(i)return i(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){var r=t[a][1][e];return s(r?r:e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,r){},{}],2:[function(e,t,r){"use strict";var n={set:function(e,t,r,n){return void 0!==r&&null!==r&&(n?e=e.set(t,r):e[t]=r),e},get:function(e,t,r){return r?e.get(t):e[t]},"delete":function(e,t,r){return r?e=e["delete"](t):Array.isArray(e)?e=e.splice(t,1):delete e[t],e}};t.exports=n},{}],3:[function(e,t,r){"use strict";var n=e("./queue"),s=e("./schema"),i=e("./store"),a=e("./immutable-store"),o=e("./bindstore"),u=e("./immutable-deep-equal"),c={version:"1.2.1",Schema:s,bindStore:o,immutableDeepEqual:u},l=function(){this.actionTypes={},this.storeQueue=[],this.id=Date.now()+Math.round(1e3*Math.random()),this.middlewareQueue=new n(function(e){this.__invokeCallback__(e)}.bind(this),!0)};l.prototype={__invokeCallback__:function(e){this.storeQueue.forEach(function(t){var r=t.callbacks[e.type];"function"==typeof r&&r(t.store,e)})},use:function(e){"function"==typeof e&&this.middlewareQueue.enter(e)},__dispatch__:function(e,t){var r,n=t(),s=this.actionTypes,i=n.type;if(!i)throw new Error("action type does not exist in \n"+JSON.stringify(n,null,2));if(r=s[i]){if(r!==e)throw new Error('action type "'+i+'" is duplicate')}else s[i]=e;this.middlewareQueue.execute(n)},createActions:function(e){var t,r,n=(this.id++).toString(32),s=this,i={};for(t in e)r=e[t],i[t]=function(e,t){return function(){var r=arguments;s.__dispatch__(t,function(){return e.apply(null,Array.prototype.slice.call(r))})}}(r,n);return i},createMutableStore:function(e,t){if(!t)throw new Error("schema must in createMutableStore arguments");var r=new i(e),n={get:r.get.bind(r),publish:r.publish.bind(r),subscribe:r.subscribe.bind(r),unsubscribe:r.unsubscribe.bind(r)};return this.storeQueue.push({store:r,callbacks:t}),n},createImmutableStore:function(e,t,r){r||(r=t,t=null);var n=new a(e,t),s={get:n.get.bind(n),publish:n.publish.bind(n),subscribe:n.subscribe.bind(n),unsubscribe:n.unsubscribe.bind(n)};return this.storeQueue.push({store:n,callbacks:r}),s}},c.Dispatcher=l,t.exports=c},{"./bindstore":4,"./immutable-deep-equal":8,"./immutable-store":9,"./queue":11,"./schema":12,"./store":13}],4:[function(e,t,r){"use strict";var n=function(e,t,r){var n=e.prototype.componentDidMount,s=e.prototype.componentWillUnmount,i={},a=Object.keys(r);return e.prototype.componentDidMount=function(e){var s=this;a.forEach(function(e){i[e]=r[e].bind(s),t.subscribe(e,i[e])}),"function"==typeof n&&n.apply(s,e)},e.prototype.componentWillUnmount=function(e){var r=this;a.forEach(function(e){t.unsubscribe(e,i[e])}),"function"==typeof s&&s.apply(r,e)},e};t.exports=n},{}],5:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.get,i=20,a=function(e){if(!e.id)throw new Error("Cache must set a "+e.id);this.id=e.id,this.maxLength=e.maxLength||i,this.cacheStore=[],this.idKeys={}};a.prototype={set:function(e,t){var r=this.id,n=this.cacheStore,i=n.length,a=s(e,r,t);void 0!==a&&(this.idKeys[a]?n.some(function(i,o){return s(i,r,t)===a?(n[o]=e,!0):void 0}):(this.idKeys[a]=!0,i===this.maxLength&&(a=s(n[0],r,t),delete this.idKeys[a],n.shift()),n.push(e)))},get:function(e,t){var r,n=this.cacheStore,i=n.length-1,a=this.id,o=e;if(this.idKeys[o])for(;i>-1;i--)if(r=n[i],s(r,a,t)===o)return r},"delete":function(e,t){var r,n=this.cacheStore,i=n.length-1,a=this.id,o=e;if(this.idKeys[o])for(;i>-1;i--)if(r=n[i],s(r,a,t)===o){n.splice(i,1),delete this.idKeys[o];break}}},t.exports=a},{"./accessor":2}],6:[function(e,t,r){function n(e,t,r){if(!(e instanceof Object))return e;var s,i=Object.prototype.toString.call(e).slice(8,-1);switch(i){case"Array":s=[];break;case"Date":s=new Date(e.getTime());break;case"RegExp":s=new RegExp(e);break;case"Function":break;case"Uint8Array":case"Uint8ClampedArray":case"Uint16Array":case"Uint32Array":case"Int8Array":case"Int16Array":case"Int32Array":case"Float32Array":case"Float64Array":s=e.subarray();break;default:s={}}if(t.push(e),r.push(s),e instanceof Array)for(var a=0;a<e.length;a++)s[a]=n(e[a],t,r);for(var o=Object.keys(e).sort(),u=Object.keys(s).sort(),c=0;c<o.length;c++){var l=o[c];if(u.length>0&&l===u[0])u.shift();else if(Object.prototype.hasOwnProperty.call(e,l)){var f=e[l],h=t.indexOf(f);s[l]=-1!==h?r[h]:n(e[l],t,r)}}return s}t.exports=function(e){return n(e,[],[])}},{}],7:[function(e,t,r){"use strict";var n=function(){this.handlers=[]};n.prototype={publish:function(e,t){this.handlers.forEach(function(r){r.type===e&&r.handler(t)})},subscribe:function(e,t){this.handlers.push({type:e,handler:t})},unsubscribe:function(e,t){"function"==typeof e&&(t=e,e=null);for(var r,n=0,s=!1;n<this.handlers.length;n++)r=this.handlers[n],e&&t?s=r.type===e&&r.handler===t:e?s=r.type===e:t&&(s=r.handler===t),s&&this.handlers.splice(n--,1)}},t.exports=n},{}],8:[function(e,t,r){"use strict";var n;n="undefined"!=typeof self&&self.Immutable?self.Immutable:"undefined"!=typeof global&&global.Immutable?global.Immutable:e("immutable");var s=Object.keys,i=n.is,a=function(e){return e.prototype.shouldComponentUpdate=function(e,t){var r,n=this,a=n.state,o=n.props,u=s(t||{}),c=s(e||{});return u.length!==s(a||{}).length||c.length!==s(o||{}).length?!0:(r=u.some(function(e){return a[e]!==t[e]&&!i(a[e],t[e])}),r||c.some(function(t){return o[t]!==e[t]&&!i(o[t],e[t])}))},e};t.exports=a},{immutable:1}],9:[function(e,t,r){"use strict";var n,s=e("./store");n="undefined"!=typeof self&&self.Immutable?self.Immutable:"undefined"!=typeof global&&global.Immutable?global.Immutable:e("immutable");var i=function(e,t){s.call(this,e,t,n)};i.prototype=Object.create(s.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),t.exports=i},{"./store":13,immutable:1}],10:[function(e,t,r){"use strict";var n="Ballade.",s={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},i={set:function(e,t,r){if("localStorage"!==r&&"sessionStorage"!==r)throw new Error("persistence params must be set localStorage or sessionStorage");e=n+e;var i=typeof t;s[i]?t+="":t=JSON.stringify(t),t=i+"@"+t,window[r].setItem(e,t)},get:function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e;var r=window[t].getItem(e);if(r){var i=r.indexOf("@"),a=r.slice(0,i);return r=r.slice(i+1),s[a]?r:JSON.parse(r)}},"delete":function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e,window[t].removeItem(e)}};t.exports=i},{}],11:[function(e,t,r){"use strict";var n=function(e,t){this.workflows=[],this.completeCallback=e,t&&(this._workflows=[])};n.prototype={enter:function(e){this.workflows.push(e),this._workflows&&this._workflows.push(e)},execute:function(e,t){t=t||this.workflows.concat();var r;t.length?(r=t.shift())(e,this.execute.bind(this,e,t)):(this._workflows&&(this.workflows=this._workflows.concat()),t=null,this.completeCallback(e))}},t.exports=n},{}],12:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.set,i=n.get,a=n["delete"],o="__schemaType__",u="__schemaTypeHook__",c="__schemaContainer__",l="__schemaItem__",f="__schemaConstructor__",h="__schemaChild__",p=Object.prototype.toString,m=function(e,t){return t&&"function"==typeof e.toJS&&(e=e.toJS()),p.call(e).slice(8,-1)},d={$required:function(e){return e},$default:function(e,t){return null===e||void 0===e?"Function"===m(t)?t():t:e},$validate:function(e,t){return t(e)},String:{$lowercase:function(e){return e.toLowerCase()},$uppercase:function(e){return e.toUpperCase()},$trim:function(e){return e.trim()},$match:function(e,t){if("RegExp"!==m(t))throw new Error("Schema Options Error: `match` property must be RegExp");return t.test(e)?e:void 0},$enum:function(e,t){if(!Array.isArray(t)||!t.length)throw new Error("Schema Options Error: `enum` must be correct Array");return~t.indexOf(e)?e:void 0}},Number:{$min:function(e,t){return e>=t?e:void 0},$max:function(e,t){return t>=e?e:void 0}}};d.Date=d.Number;var y=function(e,t,r){var n={};if(null===t||void 0===t)return n;try{"Date"!==r[o]?(n.message={path:e,originalValue:t,type:"warning",message:"Expect type is "+r[o]+", not "+m(t)},n.value=r[f](t)):n.value=new Date(t)}catch(s){n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed, "+s.message}}return"Number"===r[o]?isFinite(n.value)||(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value):"String"===r[o]&&"object"==typeof t&&(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value),n},b=function(e,t,r){var n=Array.isArray(e),s=n?e.slice(0,1):Object.keys(e);s.forEach(function(s){var i=n?s:e[s];if(s=n?l:s,t[s]={},"function"==typeof i){if("Array"===i.name||"Object"===i.name)return void(t[s][o]="Mixed");t[s][o]=i.name,t[s][f]=i}else if(Array.isArray(i)){if(!i.length)return void(t[s][o]="Mixed");t[s][c]="Array",r[s]=[],b(i,t[s],r[s])}else{if("Object"!==m(i))throw new Error("Set `"+s+"` schema error, may be forget set `$type` property or `type Constructor Function`");if(!Object.keys(i).length)return void(t[s][o]="Mixed");"function"==typeof i.$type?(t[s][o]=i.$type.name,t[s][f]=i.$type,t[s][u]=[],Object.keys(i).forEach(function(e){"$type"===e||"$default"!==e&&!i[e]||(t[s][u].push({key:e,value:i[e]}),"$default"===e&&("Function"===m(i[e])?s===l?r.push(i.$default()):r[s]=i.$default():s===l?r.push(i.$default):r[s]=i.$default))}),t[s][u].length||delete t[s][u]):i instanceof S?(t[s][o]="Schema",t[s][h]=i,s===l?Object.keys(i.defaultData).length&&r.push(i.defaultData):r[s]=i.defaultData):(t[s][c]="Object",r[s]={},b(i,t[s],r[s]))}})},v=function(e,t){var r={},n=t[o];return t[u].forEach(function(t){if(!r.message){var s=t.key,i=t.value,a=d[s]||d[n][s];a&&(e=a(e,i),void 0===e&&(r.message="Value convert faild for `"+s+"` schema options"))}}),r.value=e,r},g=function(e,t,r,n){var l,f={},h=[],p=this,d=0;return Object.keys(t).forEach(function(l){if("__schema"!==l.slice(0,8)){d++;var f,b,g,w=t[l],_=i(e,l,n),S=r+"."+l;w[c]?(b=p.validator(l,_,n,w,S),"value"in b&&(e=s(e,l,b.value,n)),b.messages&&(h=h.concat(b.messages))):(void 0!==_&&m(_)!==w[o]&&(b=y(S,_,w),e="value"in b?s(e,l,b.value,n):a(e,l,n),b.message&&h.push(b.message)),w[u]&&(g=i(e,l,n),f=v(g,w),e=s(e,l,f.value,n),f.message&&(h.push({path:S,originalValue:g,type:"error",message:f.message}),e=a(e,l,n))))}}),n?e.forEach(function(r,n){n in t||(e=a(e,n,!0))}):(l=Object.keys(e),l.length>d&&l.forEach(function(r){r in t||delete e[r]}),l=null),f.value=e,h.length&&(f.messages=h),f},w=function(e,t,r,n){var f={},p=[],d=this,b=t[l],w=b[c],_=b[o],S=b[h],x=b[u];return e.forEach(function(t,o){var u,c,f,h,O=!0,k=r+"["+o+"]";w?(c=d.validator(l,t,n,b,k),e=s(e,o,c.value,n),c.messages&&(p=p.concat(c.messages))):"Schema"===_?(h=g.call(d,t,S.dataTypes,k,n),"value"in h&&(e=s(e,o,h.value,n)),"messages"in h&&(p=p.concat(h.messages))):(m(t)!==_&&(c=y(k,t,b),"value"in c?e=s(e,o,c.value,n):(a(e,o,n),O=!1),c.message&&p.push(c.message)),O&&x&&(f=i(e,o,n),u=v(f,b),e=s(e,o,u.value,n),u.message&&(p.push({path:k,originalValue:f,type:"error",message:u.message}),a(e,o,n))))}),f.value=e,p.length&&(f.messages=p),f},_=function(e,t,r){var n,s,i={},a=[],c=m(e);return t[o]===c?i.value=e:(s=y(r,e,t),"value"in s&&(i.value=s.value),s.message&&a.push(s.message)),"value"in i&&t[u]&&(n=v(i.value,t),i.value=n.value,n.message&&(a.push({path:r,originalValue:i.value,type:"error",message:n.message}),delete i.value)),a.length&&(i.messages=a),i},S=function(e){if("Object"!==m(e))throw new Error("Schema type must be plain Object");this.dataTypes={},this.defaultData={},b(e,this.dataTypes,this.defaultData)};S.prototype={validator:function(e,t,r,n,s){if(n=n||this.dataTypes[e],s=s||e,void 0===t)return{};var i=n[c],a=m(t,r);return n?"Mixed"===n[o]?{value:t}:"Schema"===n[o]?g.call(this,t,n[h].dataTypes,s,r):"Array"===i&&"Array"===a?w.call(this,t,n,s,r):"Object"===i&&"Object"===a?g.call(this,t,n,s,r):_.call(this,t,n,s):[{path:s,originalValue:t,type:"error",message:"Not declared in Schema"}]}},t.exports=S},{"./accessor":2}],13:[function(e,t,r){"use strict";var n=Object.prototype.toString,s=e("./copy"),i=e("./event"),a=e("./cache"),o=e("./persistence"),u={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},c=function(e){return n.call(e).slice(8,-1)},l=function(e,t){var r=c(e);return"Array"===r||"Object"===r?t.fromJS(e):e},f=function(e,t,r){i.call(this),t=t||{};var n=e.defaultData,s=t.cache,u=this;this.store={},this.cache={},this.schema=e,this.Immutable=r,this.options=t,Object.keys(e.dataTypes).forEach(function(e){var t,i=s&&e in s,c=!1;i&&s[e].id&&(u.cache[e]=new a(s[e]),c=!0),i&&s[e].persistence&&(t=o.get(s[e].persistence.prefix+"."+e,s[e].persistence.type)),(null===t||void 0===t)&&(t=n[e]),null!==t&&void 0!==t&&(r&&(t=l(t,r)),c?u.cache[e].set(t,!!r):u.store[e]=t)})};f.prototype=Object.create(i.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),f.prototype.set=function(e,t,r){var n,s=this.options,i=s.cache,a=this.Immutable&&"Function"===c(t.toJS),u=this.schema.validator(e,t,a),f=[];return u.messages&&(u.messages.forEach(function(e){"warning"===e.type||"error"===e.type&&f.push(e)}),s&&s.error&&s.error({key:e,type:"SCHEMA_VALIDATION_ERROR",messages:f},this)),"value"in u?(n=this.Immutable?a?u.value:l(u.value,this.Immutable):u.value,e in this.cache?this.cache[e].set(n,!!this.Immutable):this.store[e]=n,i&&i[e]&&i[e].persistence&&o.set(i[e].persistence.prefix+"."+e,n,i[e].persistence.type),r||this.publish(e,n),e):void 0},f.prototype.get=function(e,t){var r,n,i=!!this.Immutable;return r=e in this.cache?void 0!==t?this.cache[e].get(t,i):this.cache[e].cacheStore:this.store[e],i?r:(n=typeof r,u[n]?r:s(r))},f.prototype["delete"]=function(e,t){var r=this.options.cache;return t&&e in this.cache?this.cache[e]["delete"](t,!!this.Immutable):delete this.store[e],r&&r[e]&&r[e].persistence&&o["delete"](r[e].persistence.prefix+"."+e,r[e].persistence.type),e},t.exports=f},{"./cache":5,"./copy":6,"./event":7,"./persistence":10}]},{},[3])(3)});