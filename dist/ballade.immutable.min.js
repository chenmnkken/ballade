!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Ballade=e()}}(function(){return function e(t,r,n){function s(i,o){if(!r[i]){if(!t[i]){var u="function"==typeof require&&require;if(!o&&u)return u(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[i]={exports:{}};t[i][0].call(l.exports,function(e){var r=t[i][1][e];return s(r?r:e)},l,l.exports,e,t,r,n)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)s(n[i]);return s}({1:[function(e,t,r){},{}],2:[function(e,t,r){"use strict";var n={set:function(e,t,r,n){return void 0!==r&&null!==r&&(n?e=e.set(t,r):e[t]=r),e},get:function(e,t,r){return r?e.get(t):e[t]},"delete":function(e,t,r){return r?e=e["delete"](t):Array.isArray(e)?e=e.splice(t,1):delete e[t],e}};t.exports=n},{}],3:[function(e,t,r){"use strict";var n=e("./queue"),s=e("./schema"),a=e("./store"),i=e("./immutable-store"),o=e("./bindstore"),u=e("./immutable-deep-equal"),c={version:"1.2.5",Schema:s,bindStore:o,immutableDeepEqual:u},l=function(){this.actionTypes={},this.storeQueue=[],this.id=Date.now()+Math.round(1e3*Math.random()),this.middlewareQueue=new n(function(e){this.__invokeCallback__(e)}.bind(this),!0)};l.prototype={__invokeCallback__:function(e){this.storeQueue.forEach(function(t){var r=t.callbacks[e.type];"function"==typeof r&&r(t.store,e)})},use:function(e){"function"==typeof e&&this.middlewareQueue.enter(e)},__dispatch__:function(e,t){var r,n=t(),s=this.actionTypes,a=n.type;if(!a)throw new Error("action type does not exist in \n"+JSON.stringify(n,null,2));if(r=s[a]){if(r!==e)throw new Error('action type "'+a+'" is duplicate')}else s[a]=e;this.middlewareQueue.execute(n)},createActions:function(e){var t,r,n=(this.id++).toString(32),s=this,a={};for(t in e)r=e[t],a[t]=function(e,t){return function(){var r=arguments;s.__dispatch__(t,function(){return e.apply(null,Array.prototype.slice.call(r))})}}(r,n);return a},createMutableStore:function(e,t){if(!t)throw new Error("schema must in createMutableStore arguments");var r=new a(e),n={id:r.id,get:r.get.bind(r),publish:r.publish.bind(r),subscribe:r.subscribe.bind(r),unsubscribe:r.unsubscribe.bind(r)};return this.storeQueue.push({store:r,callbacks:t}),n},createImmutableStore:function(e,t,r){r||(r=t,t=null);var n=new i(e,t),s={id:n.id,get:n.get.bind(n),publish:n.publish.bind(n),subscribe:n.subscribe.bind(n),unsubscribe:n.unsubscribe.bind(n)};return this.storeQueue.push({store:n,callbacks:r}),s}},c.Dispatcher=l,t.exports=c},{"./bindstore":4,"./immutable-deep-equal":8,"./immutable-store":9,"./queue":11,"./schema":12,"./store":13}],4:[function(e,t,r){"use strict";var n=function(e,t,r){var n=e.prototype.componentDidMount,s=e.prototype.componentWillUnmount,a=Object.keys(r);return a.length&&(e.prototype.componentDidMount=function(e){var s=this,i={};s.__storeCallback__||(s.__storeCallback__={}),a.forEach(function(e){i[e]=r[e].bind(s),t.subscribe(e,i[e])}),s.__storeCallback__[t.id]=i,"function"==typeof n&&n.apply(s,e)},e.prototype.componentWillUnmount=function(e){var r=this;a.forEach(function(e){t.unsubscribe(e,r.__storeCallback__[t.id][e])}),delete r.__storeCallback__[t.id],Object.keys(r.__storeCallback__).length||delete r.__storeCallback__,"function"==typeof s&&s.apply(r,e)}),e};t.exports=n},{}],5:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.get,a=20,i=function(e){if(!e.id)throw new Error("Cache must set a "+e.id);this.id=e.id,this.maxLength=e.maxLength||a,this.cacheStore=[],this.idKeys={}};i.prototype={set:function(e,t){var r=this.id,n=this.cacheStore,a=n.length,i=s(e,r,t);void 0!==i&&(this.idKeys[i]?n.some(function(a,o){return s(a,r,t)===i?(n[o]=e,!0):void 0}):(this.idKeys[i]=!0,a===this.maxLength&&(i=s(n[0],r,t),delete this.idKeys[i],n.shift()),n.push(e)))},get:function(e,t){var r,n=this.cacheStore,a=n.length-1,i=this.id,o=e;if(this.idKeys[o])for(;a>-1;a--)if(r=n[a],s(r,i,t)===o)return r},"delete":function(e,t){var r,n=this.cacheStore,a=n.length-1,i=this.id,o=e;if(this.idKeys[o])for(;a>-1;a--)if(r=n[a],s(r,i,t)===o){n.splice(a,1),delete this.idKeys[o];break}}},t.exports=i},{"./accessor":2}],6:[function(e,t,r){function n(e,t,r){if(!(e instanceof Object))return e;var s,a=Object.prototype.toString.call(e).slice(8,-1);switch(a){case"Array":s=[];break;case"Date":s=new Date(e.getTime());break;case"RegExp":s=new RegExp(e);break;case"Function":break;case"Uint8Array":case"Uint8ClampedArray":case"Uint16Array":case"Uint32Array":case"Int8Array":case"Int16Array":case"Int32Array":case"Float32Array":case"Float64Array":s=e.subarray();break;default:s={}}if(t.push(e),r.push(s),e instanceof Array)for(var i=0;i<e.length;i++)s[i]=n(e[i],t,r);for(var o=Object.keys(e).sort(),u=Object.keys(s).sort(),c=0;c<o.length;c++){var l=o[c];if(u.length>0&&l===u[0])u.shift();else if(Object.prototype.hasOwnProperty.call(e,l)){var f=e[l],h=t.indexOf(f);s[l]=-1!==h?r[h]:n(e[l],t,r)}}return s}t.exports=function(e){return n(e,[],[])}},{}],7:[function(e,t,r){"use strict";var n=function(){this.handlers=[]};n.prototype={publish:function(e,t){this.handlers.forEach(function(r){r.type===e&&r.handler(t)})},subscribe:function(e,t){this.handlers.push({type:e,handler:t})},unsubscribe:function(e,t){"function"==typeof e&&(t=e,e=null);for(var r,n=0,s=!1;n<this.handlers.length;n++)r=this.handlers[n],e&&t?s=r.type===e&&r.handler===t:e?s=r.type===e:t&&(s=r.handler===t),s&&this.handlers.splice(n--,1)}},t.exports=n},{}],8:[function(e,t,r){"use strict";var n;n="undefined"!=typeof self&&self.Immutable?self.Immutable:"undefined"!=typeof global&&global.Immutable?global.Immutable:e("immutable");var s=Object.keys,a=n.is,i=function(e){return e.prototype.shouldComponentUpdate=function(e,t){var r,n=this,i=n.state,o=n.props,u=s(t||{}),c=s(e||{});return u.length!==s(i||{}).length||c.length!==s(o||{}).length?!0:(r=u.some(function(e){return i[e]!==t[e]&&!a(i[e],t[e])}),r||c.some(function(t){return o[t]!==e[t]&&!a(o[t],e[t])}))},e};t.exports=i},{immutable:1}],9:[function(e,t,r){"use strict";var n,s=e("./store");n="undefined"!=typeof self&&self.Immutable?self.Immutable:"undefined"!=typeof global&&global.Immutable?global.Immutable:e("immutable");var a=function(e,t){s.call(this,e,t,n)};a.prototype=Object.create(s.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),t.exports=a},{"./store":13,immutable:1}],10:[function(e,t,r){"use strict";var n="Ballade.",s={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},a={set:function(e,t,r){if("localStorage"!==r&&"sessionStorage"!==r)throw new Error("persistence params must be set localStorage or sessionStorage");e=n+e;var a=typeof t;s[a]?t+="":t=JSON.stringify(t),t=a+"@"+t,window[r].setItem(e,t)},get:function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e;var r=window[t].getItem(e);if(r){var a=r.indexOf("@"),i=r.slice(0,a);return r=r.slice(a+1),s[i]?r:JSON.parse(r)}},"delete":function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e,window[t].removeItem(e)}};t.exports=a},{}],11:[function(e,t,r){"use strict";var n=function(e,t){this.workflows=[],this.completeCallback=e,t&&(this._workflows=[])};n.prototype={enter:function(e){this.workflows.push(e),this._workflows&&this._workflows.push(e)},execute:function(e,t){t=t||this.workflows.concat();var r;t.length?(r=t.shift())(e,this.execute.bind(this,e,t)):(this._workflows&&(this.workflows=this._workflows.concat()),t=null,this.completeCallback(e))}},t.exports=n},{}],12:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.set,a=n.get,i=n["delete"],o="__schemaType__",u="__schemaTypeHook__",c="__schemaContainer__",l="__schemaItem__",f="__schemaConstructor__",h="__schemaChild__",p=Object.prototype.toString,d=function(e,t){return t&&"function"==typeof e.toJS&&(e=e.toJS()),p.call(e).slice(8,-1)},m={$required:function(e){return e},$default:function(e,t){return null===e||void 0===e?"Function"===d(t)?t():t:e},$validate:function(e,t){return t(e)},String:{$lowercase:function(e){return e.toLowerCase()},$uppercase:function(e){return e.toUpperCase()},$trim:function(e){return e.trim()},$match:function(e,t){if("RegExp"!==d(t))throw new Error("Schema Options Error: `match` property must be RegExp");return t.test(e)?e:void 0},$enum:function(e,t){if(!Array.isArray(t)||!t.length)throw new Error("Schema Options Error: `enum` must be correct Array");return~t.indexOf(e)?e:void 0}},Number:{$min:function(e,t){return e>=t?e:void 0},$max:function(e,t){return t>=e?e:void 0}}};m.Date=m.Number;var y=function(e,t,r){var n={};if(null===t||void 0===t)return n;try{"Date"!==r[o]?(n.message={path:e,originalValue:t,type:"warning",message:"Expect type is "+r[o]+", not "+d(t)},n.value=r[f](t)):n.value=new Date(t)}catch(s){n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed, "+s.message}}return"Number"===r[o]?isFinite(n.value)||(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value):"String"===r[o]&&"object"==typeof t&&(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value),n},b=function(e,t,r){var n=Array.isArray(e),s=n?e.slice(0,1):Object.keys(e);s.forEach(function(s){var a=n?s:e[s];if(s=n?l:s,t[s]={},"function"==typeof a){if("Array"===a.name||"Object"===a.name)return void(t[s][o]="Mixed");t[s][o]=a.name,t[s][f]=a}else if(Array.isArray(a)){if(!a.length)return void(t[s][o]="Mixed");t[s][c]="Array",r[s]=[],b(a,t[s],r[s])}else{if("Object"!==d(a))throw new Error("Set `"+s+"` schema error, may be forget set `$type` property or `type Constructor Function`");if(!Object.keys(a).length)return void(t[s][o]="Mixed");if("function"==typeof a.$type){if("Array"===a.$type.name||"Object"===a.$type.name)return void(t[s][o]="Mixed");t[s][o]=a.$type.name,t[s][f]=a.$type,t[s][u]=[],Object.keys(a).forEach(function(e){"$type"===e||"$default"!==e&&!a[e]||(t[s][u].push({key:e,value:a[e]}),"$default"===e&&("Function"===d(a[e])?s===l?r.push(a.$default()):r[s]=a.$default():s===l?r.push(a.$default):r[s]=a.$default))}),t[s][u].length||delete t[s][u]}else a instanceof k?(t[s][o]="Schema",t[s][h]=a,s===l?Object.keys(a.defaultData).length&&r.push(a.defaultData):r[s]=a.defaultData):(t[s][c]="Object",r[s]={},b(a,t[s],r[s]))}})},g=function(e,t){var r={},n=t[o];return t[u].forEach(function(t){if(!r.message){var s=t.key,a=t.value,i=m[s]||m[n][s];i&&(e=i(e,a),void 0===e&&(r.message="Value convert faild for `"+s+"` schema options"))}}),r.value=e,r},v=function(e,t,r,n){var l,f={},h=[],p=this,m=0;return Object.keys(t).forEach(function(l){if("__schema"!==l.slice(0,8)){m++;var f,b,v,_=t[l],w=a(e,l,n),k=r+"."+l;_[c]?(b=p.validator(l,w,n,_,k),"value"in b&&(e=s(e,l,b.value,n)),b.messages&&(h=h.concat(b.messages))):(void 0!==w&&"Mixed"!==_[o]&&d(w)!==_[o]&&(b=y(k,w,_),e="value"in b?s(e,l,b.value,n):i(e,l,n),b.message&&h.push(b.message)),_[u]&&(v=a(e,l,n),f=g(v,_),e=s(e,l,f.value,n),f.message&&(h.push({path:k,originalValue:v,type:"error",message:f.message}),e=i(e,l,n))))}}),n?e.forEach(function(r,n){n in t||(e=i(e,n,!0))}):(l=Object.keys(e),l.length>m&&l.forEach(function(r){r in t||delete e[r]}),l=null),f.value=e,h.length&&(f.messages=h),f},_=function(e,t,r,n){var f={},p=[],m=this,b=t[l],_=b[c],w=b[o],k=b[h],S=b[u];return e.forEach(function(t,o){var u,c,f,h,x=!0,O=r+"["+o+"]";_?(c=m.validator(l,t,n,b,O),e=s(e,o,c.value,n),c.messages&&(p=p.concat(c.messages))):"Schema"===w?(h=v.call(m,t,k.dataTypes,O,n),"value"in h&&(e=s(e,o,h.value,n)),"messages"in h&&(p=p.concat(h.messages))):(d(t)!==w&&(c=y(O,t,b),"value"in c?e=s(e,o,c.value,n):(i(e,o,n),x=!1),c.message&&p.push(c.message)),x&&S&&(f=a(e,o,n),u=g(f,b),e=s(e,o,u.value,n),u.message&&(p.push({path:O,originalValue:f,type:"error",message:u.message}),i(e,o,n))))}),f.value=e,p.length&&(f.messages=p),f},w=function(e,t,r){var n,s,a={},i=[],c=d(e);return t[o]===c?a.value=e:(s=y(r,e,t),"value"in s&&(a.value=s.value),s.message&&i.push(s.message)),"value"in a&&t[u]&&(n=g(a.value,t),a.value=n.value,n.message&&(i.push({path:r,originalValue:a.value,type:"error",message:n.message}),delete a.value)),i.length&&(a.messages=i),a},k=function(e){if("Object"!==d(e))throw new Error("Schema type must be plain Object");this.dataTypes={},this.defaultData={},b(e,this.dataTypes,this.defaultData)};k.prototype={validator:function(e,t,r,n,s){if(n=n||this.dataTypes[e],s=s||e,void 0===t)return{};var a=n[c],i=d(t,r);return n?"Mixed"===n[o]?{value:t}:"Schema"===n[o]?v.call(this,t,n[h].dataTypes,s,r):"Array"===a&&"Array"===i?_.call(this,t,n,s,r):"Object"===a&&"Object"===i?v.call(this,t,n,s,r):w.call(this,t,n,s):[{path:s,originalValue:t,type:"error",message:"Not declared in Schema"}]}},t.exports=k},{"./accessor":2}],13:[function(e,t,r){"use strict";var n=Object.prototype.toString,s=e("./copy"),a=e("./event"),i=e("./cache"),o=e("./persistence"),u={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},c=function(e){return n.call(e).slice(8,-1)},l=function(e,t){var r=c(e);return"Array"===r||"Object"===r?t.fromJS(e):e},f=function(e,t,r){a.call(this),t=t||{};var n=e.defaultData,s=t.cache,u=this;this.store={},this.cache={},this.schema=e,this.Immutable=r,this.options=t,this.id="BalladeStore-"+(+new Date+Math.floor(999999*Math.random())).toString(36),Object.keys(e.dataTypes).forEach(function(e){var t,a=s&&e in s,c=!1;a&&s[e].id&&(u.cache[e]=new i(s[e]),c=!0),a&&s[e].persistence&&(t=o.get(s[e].persistence.prefix+"."+e,s[e].persistence.type)),(null===t||void 0===t)&&(t=n[e]),null!==t&&void 0!==t&&(r&&(t=l(t,r)),c?u.cache[e].set(t,!!r):u.store[e]=t)})};f.prototype=Object.create(a.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),f.prototype.set=function(e,t,r){var n,s=this.options,a=s.cache,i=this.Immutable&&"Function"===c(t.toJS),u=this.schema.validator(e,t,i),f=[];return u.messages&&(u.messages.forEach(function(e){"warning"===e.type||"error"===e.type&&f.push(e)}),s&&s.error&&s.error({key:e,type:"SCHEMA_VALIDATION_ERROR",messages:f},this)),"value"in u?(n=this.Immutable?i?u.value:l(u.value,this.Immutable):u.value,e in this.cache?this.cache[e].set(n,!!this.Immutable):this.store[e]=n,a&&a[e]&&a[e].persistence&&o.set(a[e].persistence.prefix+"."+e,n,a[e].persistence.type),r||this.publish(e,n),e):void 0},f.prototype.get=function(e,t){var r,n,a=!!this.Immutable;return r=e in this.cache?void 0!==t?this.cache[e].get(t,a):this.cache[e].cacheStore:this.store[e],a?r:(n=typeof r,u[n]?r:s(r))},f.prototype["delete"]=function(e,t){var r=this.options.cache;return t&&e in this.cache?this.cache[e]["delete"](t,!!this.Immutable):delete this.store[e],r&&r[e]&&r[e].persistence&&o["delete"](r[e].persistence.prefix+"."+e,r[e].persistence.type),e},t.exports=f},{"./cache":5,"./copy":6,"./event":7,"./persistence":10}]},{},[3])(3)});