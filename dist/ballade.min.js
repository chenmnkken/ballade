!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Ballade=e()}}(function(){return function e(t,r,n){function s(a,o){if(!r[a]){if(!t[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){var r=t[a][1][e];return s(r?r:e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,r){"use strict";var n={set:function(e,t,r,n){return void 0!==r&&null!==r&&(n?e=e.set(t,r):e[t]=r),e},get:function(e,t,r){return r?e.get(t):e[t]},"delete":function(e,t,r){return r?e=e["delete"](t):Array.isArray(e)?e=e.splice(t,1):delete e[t],e}};t.exports=n},{}],2:[function(e,t,r){"use strict";var n=e("./queue"),s=e("./schema"),i=e("./store"),a=e("./bindstore"),o={version:"1.2.8",Schema:s,bindStore:a},c=function(){this.actionTypes={},this.storeQueue=[],this.id=Date.now()+Math.round(1e3*Math.random()),this.middlewareQueue=new n(function(e){this.__invokeCallback__(e)}.bind(this),!0)};c.prototype={__invokeCallback__:function(e){this.storeQueue.forEach(function(t){var r=t.callbacks[e.type];"function"==typeof r&&setTimeout(function(){r(t.store,e)},0)})},use:function(e){"function"==typeof e&&this.middlewareQueue.enter(e)},__dispatch__:function(e,t){var r,n=t(),s=this.actionTypes,i=n.type;if(!i)throw new Error("action type does not exist in \n"+JSON.stringify(n,null,2));if(r=s[i]){if(r!==e)throw new Error('action type "'+i+'" is duplicate')}else s[i]=e;this.middlewareQueue.execute(n)},createActions:function(e){var t,r,n=(this.id++).toString(32),s=this,i={};for(t in e)r=e[t],i[t]=function(e,t){return function(){var r=arguments;s.__dispatch__(t,function(){return e.apply(null,Array.prototype.slice.call(r))})}}(r,n);return i},createMutableStore:function(e,t,r){r||(r=t,t=null);var n=new i(e,t),s={id:n.id,get:n.get.bind(n),publish:n.publish.bind(n),subscribe:n.subscribe.bind(n),unsubscribe:n.unsubscribe.bind(n)};return this.storeQueue.push({store:n,callbacks:r}),s}},o.Dispatcher=c,t.exports=o},{"./bindstore":3,"./queue":8,"./schema":9,"./store":10}],3:[function(e,t,r){"use strict";var n=function(e,t,r){var n=e.prototype.componentDidMount,s=e.prototype.componentWillUnmount,i=Object.keys(r);return i.length&&(e.prototype.componentDidMount=function(e){var s=this,a={};s.__storeCallback__||(s.__storeCallback__={}),i.forEach(function(e){a[e]=r[e].bind(s),t.subscribe(e,a[e])}),s.__storeCallback__[t.id]=a,"function"==typeof n&&n.apply(s,e)},e.prototype.componentWillUnmount=function(e){var r=this;i.forEach(function(e){t.unsubscribe(e,r.__storeCallback__[t.id][e])}),delete r.__storeCallback__[t.id],Object.keys(r.__storeCallback__).length||delete r.__storeCallback__,"function"==typeof s&&s.apply(r,e)}),e};t.exports=n},{}],4:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.get,i=20,a=function(e){if(!e.id)throw new Error("Cache must set a "+e.id);this.id=e.id,this.maxLength=e.maxLength||i,this.cacheStore=[],this.idKeys={}};a.prototype={set:function(e,t){var r=this.id,n=this.cacheStore,i=n.length,a=s(e,r,t);void 0!==a&&(this.idKeys[a]?n.some(function(i,o){return s(i,r,t)===a?(n[o]=e,!0):void 0}):(this.idKeys[a]=!0,i===this.maxLength&&(a=s(n[0],r,t),delete this.idKeys[a],n.shift()),n.push(e)))},get:function(e,t){var r,n=this.cacheStore,i=n.length-1,a=this.id,o=e;if(this.idKeys[o])for(;i>-1;i--)if(r=n[i],s(r,a,t)===o)return r},"delete":function(e,t){var r,n=this.cacheStore,i=n.length-1,a=this.id,o=e;if(this.idKeys[o])for(;i>-1;i--)if(r=n[i],s(r,a,t)===o){n.splice(i,1),delete this.idKeys[o];break}}},t.exports=a},{"./accessor":1}],5:[function(e,t,r){function n(e,t,r){if(!(e instanceof Object))return e;var s,i=Object.prototype.toString.call(e).slice(8,-1);switch(i){case"Array":s=[];break;case"Date":s=new Date(e.getTime());break;case"RegExp":s=new RegExp(e);break;case"Function":break;case"Uint8Array":case"Uint8ClampedArray":case"Uint16Array":case"Uint32Array":case"Int8Array":case"Int16Array":case"Int32Array":case"Float32Array":case"Float64Array":s=e.subarray();break;default:s={}}if(t.push(e),r.push(s),e instanceof Array)for(var a=0;a<e.length;a++)s[a]=n(e[a],t,r);for(var o=Object.keys(e).sort(),c=Object.keys(s).sort(),u=0;u<o.length;u++){var l=o[u];if(c.length>0&&l===c[0])c.shift();else if(Object.prototype.hasOwnProperty.call(e,l)){var h=e[l],f=t.indexOf(h);s[l]=-1!==f?r[f]:n(e[l],t,r)}}return s}t.exports=function(e){return n(e,[],[])}},{}],6:[function(e,t,r){"use strict";var n=function(){this.handlers=[]};n.prototype={publish:function(e,t){this.handlers.forEach(function(r){r.type===e&&r.handler(t)})},subscribe:function(e,t){this.handlers.push({type:e,handler:t})},unsubscribe:function(e,t){"function"==typeof e&&(t=e,e=null);for(var r,n=0,s=!1;n<this.handlers.length;n++)r=this.handlers[n],e&&t?s=r.type===e&&r.handler===t:e?s=r.type===e:t&&(s=r.handler===t),s&&this.handlers.splice(n--,1)}},t.exports=n},{}],7:[function(e,t,r){"use strict";var n="Ballade.",s={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},i={set:function(e,t,r){if("localStorage"!==r&&"sessionStorage"!==r)throw new Error("persistence params must be set localStorage or sessionStorage");e=n+e;var i=typeof t;s[i]?t+="":t=JSON.stringify(t),t=i+"@"+t,window[r].setItem(e,t)},get:function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e;var r=window[t].getItem(e);if(r){var i=r.indexOf("@"),a=r.slice(0,i);return r=r.slice(i+1),s[a]?r:JSON.parse(r)}},"delete":function(e,t){if("localStorage"!==t&&"sessionStorage"!==t)throw new Error("persistence type must be set localStorage or sessionStorage");e=n+e,window[t].removeItem(e)}};t.exports=i},{}],8:[function(e,t,r){"use strict";var n=function(e,t){this.workflows=[],this.completeCallback=e,t&&(this._workflows=[])};n.prototype={enter:function(e){this.workflows.push(e),this._workflows&&this._workflows.push(e)},execute:function(e,t){t=t||this.workflows.concat();var r;t.length?(r=t.shift())(e,this.execute.bind(this,e,t)):(this._workflows&&(this.workflows=this._workflows.concat()),t=null,this.completeCallback(e))}},t.exports=n},{}],9:[function(e,t,r){"use strict";var n=e("./accessor"),s=n.set,i=n.get,a=n["delete"],o="__schemaType__",c="__schemaTypeHook__",u="__schemaContainer__",l="__schemaItem__",h="__schemaConstructor__",f="__schemaChild__",p=Object.prototype.toString,d=function(e,t){return t&&"function"==typeof e.toJS&&(e=e.toJS()),p.call(e).slice(8,-1)},y={$required:function(e){return e},$default:function(e,t){return null===e||void 0===e?"Function"===d(t)?t():t:e},$validate:function(e,t){return t(e)},String:{$lowercase:function(e){return e.toLowerCase()},$uppercase:function(e){return e.toUpperCase()},$trim:function(e){return e.trim()},$match:function(e,t){if("RegExp"!==d(t))throw new Error("Schema Options Error: `match` property must be RegExp");return t.test(e)?e:void 0},$enum:function(e,t){if(!Array.isArray(t)||!t.length)throw new Error("Schema Options Error: `enum` must be correct Array");return~t.indexOf(e)?e:void 0}},Number:{$min:function(e,t){return e>=t?e:void 0},$max:function(e,t){return t>=e?e:void 0}}};y.Date=y.Number;var m=function(e,t,r){var n={};if(null===t||void 0===t)return n;try{"Date"!==r[o]?(n.message={path:e,originalValue:t,type:"warning",message:"Expect type is "+r[o]+", not "+d(t)},n.value=r[h](t)):n.value=new Date(t)}catch(s){n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed, "+s.message}}return"Number"===r[o]?isFinite(n.value)||(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value):"String"===r[o]&&"object"==typeof t&&(n.message={path:e,originalValue:t,type:"error",message:"Cast to "+r[o]+" failed"},delete n.value),n},v=function(e,t,r){var n=Array.isArray(e),s=n?e.slice(0,1):Object.keys(e);s.forEach(function(s){var i=n?s:e[s];if(s=n?l:s,t[s]={},"function"==typeof i){if("Array"===i.name||"Object"===i.name)return t[s][o]="Mixed",void("Array"===i.name?r[s]=[]:r[s]={});t[s][o]=i.name,t[s][h]=i}else if(Array.isArray(i)){if(!i.length)return t[s][o]="Mixed",void(r[s]=[]);t[s][u]="Array",r[s]=[],v(i,t[s],r[s])}else{if("Object"!==d(i))throw new Error("Set `"+s+"` schema error, may be forget set `$type` property or `type Constructor Function`");if(!Object.keys(i).length)return t[s][o]="Mixed",void(r[s]={});if("function"==typeof i.$type){if("Array"===i.$type.name||"Object"===i.$type.name)return t[s][o]="Mixed",void("Array"===i.$type.name?r[s]=[]:r[s]={});t[s][o]=i.$type.name,t[s][h]=i.$type,t[s][c]=[],Object.keys(i).forEach(function(e){"$type"===e||"$default"!==e&&!i[e]||(t[s][c].push({key:e,value:i[e]}),"$default"===e&&("Function"===d(i[e])?s===l?r.push(i.$default()):r[s]=i.$default():s===l?r.push(i.$default):r[s]=i.$default))}),t[s][c].length||delete t[s][c]}else i instanceof k?(t[s][o]="Schema",t[s][f]=i,s===l?Object.keys(i.defaultData).length&&r.push(i.defaultData):r[s]=i.defaultData):(t[s][u]="Object",r[s]={},v(i,t[s],r[s]))}})},g=function(e,t){var r={},n=t[o];return t[c].forEach(function(t){if(!r.message){var s=t.key,i=t.value,a=y[s]||y[n][s];a&&(e=a(e,i),void 0===e&&(r.message="Value convert faild for `"+s+"` schema options"))}}),r.value=e,r},b=function(e,t,r,n){var l,h={},f=[],p=this,y=0;return Object.keys(t).forEach(function(l){if("__schema"!==l.slice(0,8)){y++;var h,v,b,_=t[l],w=i(e,l,n),k=r+"."+l;_[u]?(v=p.validator(l,w,n,_,k),"value"in v&&(e=s(e,l,v.value,n)),v.messages&&(f=f.concat(v.messages))):(void 0!==w&&"Mixed"!==_[o]&&d(w)!==_[o]&&(v=m(k,w,_),e="value"in v?s(e,l,v.value,n):a(e,l,n),v.message&&f.push(v.message)),_[c]&&(b=i(e,l,n),h=g(b,_),e=s(e,l,h.value,n),h.message&&(f.push({path:k,originalValue:b,type:"error",message:h.message}),e=a(e,l,n))))}}),n?e.forEach(function(r,n){n in t||(e=a(e,n,!0))}):(l=Object.keys(e),l.length>y&&l.forEach(function(r){r in t||delete e[r]}),l=null),h.value=e,f.length&&(h.messages=f),h},_=function(e,t,r,n){var h={},p=[],y=this,v=t[l],_=v[u],w=v[o],k=v[f],S=v[c];return e.forEach(function(t,o){var c,u,h,f,x=!0,O=r+"["+o+"]";_?(u=y.validator(l,t,n,v,O),e=s(e,o,u.value,n),u.messages&&(p=p.concat(u.messages))):"Schema"===w?(f=b.call(y,t,k.dataTypes,O,n),"value"in f&&(e=s(e,o,f.value,n)),"messages"in f&&(p=p.concat(f.messages))):(d(t)!==w&&(u=m(O,t,v),"value"in u?e=s(e,o,u.value,n):(a(e,o,n),x=!1),u.message&&p.push(u.message)),x&&S&&(h=i(e,o,n),c=g(h,v),e=s(e,o,c.value,n),c.message&&(p.push({path:O,originalValue:h,type:"error",message:c.message}),a(e,o,n))))}),h.value=e,p.length&&(h.messages=p),h},w=function(e,t,r){var n,s,i={},a=[],u=d(e);return t[o]===u?i.value=e:(s=m(r,e,t),"value"in s&&(i.value=s.value),s.message&&a.push(s.message)),"value"in i&&t[c]&&(n=g(i.value,t),i.value=n.value,n.message&&(a.push({path:r,originalValue:i.value,type:"error",message:n.message}),delete i.value)),a.length&&(i.messages=a),i},k=function(e){if("Object"!==d(e))throw new Error("Schema type must be plain Object");this.dataTypes={},this.defaultData={},v(e,this.dataTypes,this.defaultData)};k.prototype={validator:function(e,t,r,n,s){if(n=n||this.dataTypes[e],s=s||e,void 0===t)return{};var i=n[u],a=d(t,r);return n?"Mixed"===n[o]?{value:t}:"Schema"===n[o]?b.call(this,t,n[f].dataTypes,s,r):"Array"===i&&"Array"===a?_.call(this,t,n,s,r):"Object"===i&&"Object"===a?b.call(this,t,n,s,r):w.call(this,t,n,s):[{path:s,originalValue:t,type:"error",message:"Not declared in Schema"}]}},t.exports=k},{"./accessor":1}],10:[function(e,t,r){"use strict";var n=Object.prototype.toString,s=e("./copy"),i=e("./event"),a=e("./cache"),o=e("./persistence"),c={string:!0,number:!0,"null":!0,undefind:!0,"boolean":!0},u=function(e){return n.call(e).slice(8,-1)},l=function(e,t){var r=u(e);return"Array"===r||"Object"===r?t.fromJS(e):e},h=function(e,t,r){i.call(this),t=t||{};var n=e.defaultData,s=t.cache,c=this;this.store={},this.cache={},this.schema=e,this.Immutable=r,this.options=t,this.id="BalladeStore-"+(+new Date+Math.floor(999999*Math.random())).toString(36),Object.keys(e.dataTypes).forEach(function(e){var t,i=s&&e in s,u=!1;i&&s[e].id&&(c.cache[e]=new a(s[e]),u=!0),i&&s[e].persistence&&(t=o.get(s[e].persistence.prefix+"."+e,s[e].persistence.type)),(null===t||void 0===t)&&(t=n[e]),null!==t&&void 0!==t&&(r&&(t=l(t,r)),u?c.cache[e].set(t,!!r):c.store[e]=t)})};h.prototype=Object.create(i.prototype,{constructor:{value:h,enumerable:!1,writable:!0,configurable:!0}}),h.prototype.set=function(e,t,r){var n,s=this.options,i=s.cache,a=this.Immutable&&"Function"===u(t.toJS),c=this.schema.validator(e,t,a),h=[];return c.messages&&(c.messages.forEach(function(e){"warning"===e.type||"error"===e.type&&h.push(e)}),s&&s.error&&s.error({key:e,type:"SCHEMA_VALIDATION_ERROR",messages:h},this)),"value"in c?(n=this.Immutable?a?c.value:l(c.value,this.Immutable):c.value,e in this.cache?this.cache[e].set(n,!!this.Immutable):this.store[e]=n,i&&i[e]&&i[e].persistence&&o.set(i[e].persistence.prefix+"."+e,n,i[e].persistence.type),r||this.publish(e,n),e):void 0},h.prototype.get=function(e,t){var r,n,i=!!this.Immutable;return r=e in this.cache?void 0!==t?this.cache[e].get(t,i):this.cache[e].cacheStore:this.store[e],i?r:(n=typeof r,c[n]?r:s(r))},h.prototype["delete"]=function(e,t){var r=this.options.cache;return t&&e in this.cache?this.cache[e]["delete"](t,!!this.Immutable):delete this.store[e],r&&r[e]&&r[e].persistence&&o["delete"](r[e].persistence.prefix+"."+e,r[e].persistence.type),this.publish(e,this.get(e,t)),e},h.prototype.cleanCache=function(e){var t=this.cache[e];return t&&(t.cacheStore.length=0,Object.keys(t.idKeys).forEach(function(e){delete t.idKeys[e]})),e},t.exports=h},{"./cache":4,"./copy":5,"./event":6,"./persistence":7}]},{},[2])(2)});